import React,{useState,useEffect,useRef} from 'react';import {View,TextInput,TouchableOpacity,Text,StyleSheet,ActivityIndicator,SafeAreaView,Alert} from 'react-native';import axios from 'axios';import {API_ENDPOINTS,getApiHeaders} from './api';export default function VerifyOTPScreen({route,navigation}){const{mobileNumber}=route.params;const[otp,setOtp]=useState(['','','','']);const[loading,setLoading]=useState(false);const[error,setError]=useState('');const[resendTimer,setResendTimer]=useState(60);const[canResend,setCanResend]=useState(false);const inputRefs=useRef([]);useEffect(()=>{if(resendTimer>0&&!canResend){const interval=setInterval(()=>{setResendTimer(prev=>prev-1);},1000);return()=>clearInterval(interval);}else if(resendTimer===0){setCanResend(true);}},[ resendTimer,canResend]);useEffect(()=>{if(otp.every(digit=>digit!=='')){handleVerifyOTP(otp.join(''));}},[otp]);const handleOtpChange=(index,value)=>{if(/^\d?$/.test(value)){const newOtp=[...otp];newOtp[index]=value;setOtp(newOtp);setError('');if(value&&index<3){inputRefs.current[index+1]?.focus();}}};const handleKeyPress=(index,event)=>{if(event.nativeEvent.key==='Backspace'){const newOtp=[...otp];if(!otp[index]&&index>0){newOtp[index-1]='';setOtp(newOtp);inputRefs.current[index-1]?.focus();}else{newOtp[index]='';setOtp(newOtp);}}};const handleVerifyOTP=async(otpValue)=>{if(otpValue.length!==4)return;setLoading(true);setError('');try{await axios.post(`${API_ENDPOINTS.VERIFY_OTP}?mobile=${mobileNumber}&otp=${otpValue}`,{},{headers:getApiHeaders()});navigation.replace('Success',{mobileNumber});}catch(err){setError('Invalid OTP');setOtp(['','','','']);inputRefs.current[0]?.focus();}finally{setLoading(false);}};const handleResendOTP=async()=>{setLoading(true);try{await axios.post(`${API_ENDPOINTS.RESEND_OTP}?mobile=${mobileNumber}`,{},{headers:getApiHeaders()});setOtp(['','','','']);setResendTimer(60);setCanResend(false);inputRefs.current[0]?.focus();Alert.alert('Success','OTP resent');}catch(err){setError('Failed to resend');}finally{setLoading(false);}};return <SafeAreaView style={styles.container}><View style={styles.header}><TouchableOpacity onPress={()=>navigation.goBack()}><Text style={styles.backText}>‚Üê Back</Text></TouchableOpacity></View><View style={styles.content}><View style={styles.titleSection}><Text style={styles.title}>Enter OTP</Text><Text style={styles.subtitle}>Code sent to +91{mobileNumber}</Text></View><View style={styles.otpContainer}>{otp.map((digit,index)=><TextInput key={index} ref={ref=>inputRefs.current[index]=ref} style={[styles.otpInput,digit&&styles.otpInputFilled,error&&styles.otpInputError]} placeholder="0" placeholderTextColor="#ccc" keyboardType="numeric" maxLength={1} value={digit} onChangeText={value=>handleOtpChange(index,value)} onKeyPress={e=>handleKeyPress(index,e)} editable={!loading}/>)}</View>{error&&<Text style={styles.errorText}>{error}</Text>}<View style={styles.resendSection}>{canResend?<TouchableOpacity onPress={handleResendOTP} disabled={loading}><Text style={styles.resendButton}>Resend OTP</Text></TouchableOpacity>:<Text style={styles.timerText}>Resend in {resendTimer}s</Text>}</View><TouchableOpacity style={styles.changeNumber} onPress={()=>navigation.goBack()}><Text style={styles.changeNumberText}>Change Number</Text></TouchableOpacity></View>{loading&&<View style={styles.loading}><ActivityIndicator size="large" color="#007AFF"/></View>}</SafeAreaView>;} const styles=StyleSheet.create({container:{flex:1,backgroundColor:'#fff'},header:{padding:15},backText:{fontSize:16,color:'#007AFF',fontWeight:'600'},content:{flex:1,padding:20},titleSection:{alignItems:'center',marginBottom:40},title:{fontSize:28,fontWeight:'700',color:'#1a1a1a',marginBottom:8},subtitle:{fontSize:14,color:'#666'},otpContainer:{flexDirection:'row',justifyContent:'space-between',marginBottom:20},otpInput:{width:55,height:55,borderWidth:2,borderColor:'#ddd',borderRadius:10,fontSize:20,fontWeight:'bold',textAlign:'center',color:'#1a1a1a',backgroundColor:'#f9f9f9'},otpInputFilled:{borderColor:'#007AFF',backgroundColor:'#f0f8ff'},otpInputError:{borderColor:'#ff6b6b'},errorText:{color:'#ff6b6b',fontSize:12,marginBottom:15,textAlign:'center'},resendSection:{alignItems:'center',marginBottom:30},resendButton:{color:'#007AFF',fontSize:14,fontWeight:'600'},timerText:{color:'#999',fontSize:14},changeNumber:{alignItems:'center',paddingVertical:10},changeNumberText:{color:'#007AFF',fontSize:14,fontWeight:'600'},loading:{position:'absolute',top:0,left:0,right:0,bottom:0,justifyContent:'center',alignItems:'center',backgroundColor:'rgba(0,0,0,0.3)'}});
